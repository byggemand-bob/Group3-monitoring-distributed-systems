package com.Group3.monitor.client;

import com.Group3.client.ApiClient;
import com.Group3.client.ApiException;
import com.Group3.client.api.MonitorApi;
import com.Group3.monitor.model.TimingMonitorData;
import com.Group3.monitor.model.TimingMonitorData.EventCodeEnum;
import com.Group3.monitor.exception.MonitorConfigException;
import com.Group3.monitor.configuration.ConfigurationManager;

import java.io.PrintStream;
import org.threeten.bp.OffsetDateTime;

import javax.annotation.Nullable;

import org.springframework.http.HttpStatus;

import java.util.concurrent.atomic.AtomicLong;
import java.util.regex.Pattern;

public class MonitorClientInterface {
    private ApiClient client;
    private MonitorApi MonitorClient;
    private String monitorURL;
    private static AtomicLong eventIDSequence = new AtomicLong(1L);
    private static final long senderID = ConfigurationManager.getInstance().getPropertyAsLong(ConfigurationManager.getInstance().IDProp);

    public MonitorClientInterface(){
    	monitorURL = ConfigurationManager.getInstance().getProperty(ConfigurationManager.getInstance().monitorServerAddressProp);
    	client = new ApiClient();
        ValidateAndSetMonitorIP(monitorURL);
        MonitorClient = new MonitorApi(client);
    }

    private void ValidateAndSetMonitorIP(String MonitorIP){
        if (Pattern.matches("^http://\\d+.\\d+.\\d+.\\d+:\\d+$", MonitorIP)) {
            client.setBasePath(MonitorIP);
        } else if(Pattern.matches("^\\d+.\\d+.\\d+.\\d+:\\d+$", MonitorIP)){
            client.setBasePath("http://" + MonitorIP);
        } else if (Pattern.matches("^localhost:\\d+$", MonitorIP)){
            client.setBasePath("http://" + MonitorIP);
        } else if (Pattern.matches("^http://localhost:\\d+$", MonitorIP)){
            client.setBasePath(MonitorIP);
        } else {
        	String msg = String.format("IP address defined in configuration property <%s> is malformed, please check...\n"+
									   "Properties found at <%s>",
									   ConfigurationManager.getInstance().monitorServerAddressProp, 
									   ConfigurationManager.getInstance().getPropertiesPath());
        	throw new MonitorConfigException(msg);
        }
    }

    private void addMonitorData(long eventID, @Nullable String TargetEndPoint, EventCodeEnum eventCode)  {
        TimingMonitorData timingMonitorData = new TimingMonitorData();
        timingMonitorData.setEventCode(eventCode);
        timingMonitorData.setEventID(eventID);
        timingMonitorData.setSenderID(senderID);
        timingMonitorData.timestamp(OffsetDateTime.now());
        if(TargetEndPoint != null){
            timingMonitorData.setTargetEndpoint(TargetEndPoint);
        }
		
		try {
    	    MonitorClient.addMonitorData(timingMonitorData);
		} catch (ApiException e) {
			writeApiExceptionToStream(e, System.out);
		}
    }
    
    private void writeApiExceptionToStream(ApiException e, PrintStream out) {
		out.println("Received ApiException while sending monitor data: ");
		out.println("	HttpStatus: " + HttpStatus.valueOf(e.getCode()));
		out.println("	Response: " + e.getResponseBody());
		
	}
	
    public long queueMonitorData(@Nullable String targetEndPoint, EventCodeEnum eventCode)  {
    	long eventID = getNextEventID();
    	addMonitorData(eventID, targetEndPoint, eventCode);
    	return eventID;
    }
    
    public long queueMonitorData(long eventID, @Nullable String targetEndPoint, EventCodeEnum eventCode)  {
    	addMonitorData(eventID, targetEndPoint, eventCode);
    	return eventID;	
    }
    
    private long getNextEventID() {
    	return eventIDSequence.getAndIncrement();
    }
}
